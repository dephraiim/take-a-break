import React from "react";
import Head from "next/head";
import useCountDown from "react-countdown-hook";
import styles from "../styles/Home.module.css";
import { formatTime } from "../lib/util";

export default function Home() {
  const [tabHasFocus, setTabHasFocus] = React.useState(true);
  const [session, setSession] = React.useState("inactive");
  const [mouseMoved, setMouseMoved] = React.useState(false);
  const [initialTime, setInitialTime] = React.useState(2 * 60 * 1000);
  const [timeLeft, { start, pause, resume, reset }] = useCountDown(initialTime, 1000);

  const restart = React.useCallback((newTime) => start(newTime), []);
  const timerIsActive = timeLeft > 0;

  const handleMouseMove = () => {
    if (timerIsActive) {
      let timer;

      restart(initialTime);
      setMouseMoved(true);

      if (!tabHasFocus) setTabHasFocus(true);

      clearTimeout(timer);
      timer = setTimeout(() => {
        setMouseMoved(false);
      }, 1000);
    }
  };

  React.useEffect(() => {
    const handleFocus = () => {
      console.log("Tab has focus");
      setTabHasFocus(true);
    };

    const handleBlur = () => {
      console.log("Tab lost focus");
      restart(initialTime);
      pause();
      setTabHasFocus(false);
    };

    window.addEventListener("focus", handleFocus);
    window.addEventListener("blur", handleBlur);

    return () => {
      window.removeEventListener("focus", handleFocus);
      window.removeEventListener("blur", handleBlur);
    };
  }, []);

  return (
    <div className={styles.container} onMouseMove={handleMouseMove}>
      <Head>
        <title>Take a Break</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        {session === "inactive" && (
          <>
            <div>
              <button onClick={() => setInitialTime(2 * 60 * 1000)}>2 minutes</button>
              <button onClick={() => setInitialTime(3 * 60 * 1000)}>3 minutes</button>
              <button onClick={() => setInitialTime(5 * 60 * 1000)}>5 minutes</button>
            </div>
            <button
              onClick={() => {
                setSession("active");
                start(initialTime);
              }}
            >
              Start Session
            </button>
          </>
        )}

        {session === "active" && (
          <>
            {timerIsActive ? (
              <div>
                <p>{formatTime(timeLeft / 1000)}</p>
                {(mouseMoved || !tabHasFocus) && <p>Oops! Try Again</p>}
              </div>
            ) : (
              <div>
                <div>You've done a good job today.</div>
                <button
                  onClick={() => {
                    setSession("inactive");
                  }}
                >
                  Take another break?
                </button>
              </div>
            )}
          </>
        )}
      </main>
    </div>
  );
}
